rules:
  # ============================================================
  # CWE-89: SQL Injection
  # ============================================================
  - id: sql-injection-format-string
    patterns:
      - pattern-either:
          - pattern: $CURSOR.execute(f"...", ...)
          - pattern: $CURSOR.execute("..." % ..., ...)
          - pattern: $CURSOR.execute("..." + ..., ...)
          - pattern: $DB.execute(f"...", ...)
          - pattern: $DB.query(f"...", ...)
    message: "SQL Injection via string formatting"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"
      category: "security"
      
  - id: sql-injection-fstring
    pattern-regex: '(execute|query|raw)\s*\(\s*f["\'].*\{.*\}.*["\']'
    message: "Potential SQL injection via f-string"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-89"

  # ============================================================
  # CWE-78: Command Injection
  # ============================================================
  - id: command-injection-os-system
    patterns:
      - pattern-either:
          - pattern: os.system(...)
          - pattern: os.popen(...)
          - pattern: subprocess.call(..., shell=True, ...)
          - pattern: subprocess.run(..., shell=True, ...)
          - pattern: subprocess.Popen(..., shell=True, ...)
          - pattern: subprocess.check_output(..., shell=True, ...)
    message: "Command injection via shell execution"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-78"

  - id: command-injection-js
    patterns:
      - pattern-either:
          - pattern: exec(...)
          - pattern: execSync(...)
          - pattern: spawn(..., { shell: true })
    message: "Command injection in JavaScript"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-78"

  # ============================================================
  # CWE-79: Cross-Site Scripting (XSS)
  # ============================================================
  - id: xss-flask-render
    patterns:
      - pattern: return f"<...$USER_INPUT...</...>"
      - pattern: return "<..." + $USER_INPUT + "...</...>"
    message: "XSS via direct HTML rendering"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-79"

  - id: xss-innerhtml
    pattern: $EL.innerHTML = $USER_INPUT
    message: "XSS via innerHTML assignment"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-79"

  - id: xss-document-write
    pattern: document.write(...)
    message: "XSS via document.write"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-79"

  # ============================================================
  # CWE-22: Path Traversal
  # ============================================================
  - id: path-traversal-open
    patterns:
      - pattern: open($PATH, ...)
      - pattern: open(f"...$USER_INPUT...", ...)
    message: "Potential path traversal in file open"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"

  - id: path-traversal-join-no-check
    pattern: |
      os.path.join($BASE, $USER_INPUT)
      ...
      open(...)
    message: "Path traversal - os.path.join doesn't prevent absolute paths"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-22"

  # ============================================================
  # CWE-918: Server-Side Request Forgery (SSRF)
  # ============================================================
  - id: ssrf-requests
    patterns:
      - pattern: requests.get($URL, ...)
      - pattern: requests.post($URL, ...)
      - pattern: urllib.request.urlopen($URL)
      - pattern: urllib.urlopen($URL)
    message: "Potential SSRF - validate URL before fetching"
    languages: [python]
    severity: WARNING
    metadata:
      cwe: "CWE-918"

  - id: ssrf-fetch
    pattern: fetch($URL, ...)
    message: "Potential SSRF via fetch"
    languages: [javascript, typescript]
    severity: WARNING
    metadata:
      cwe: "CWE-918"

  # ============================================================
  # CWE-611: XML External Entity (XXE)
  # ============================================================
  - id: xxe-etree
    patterns:
      - pattern: etree.parse(...)
      - pattern: etree.fromstring(...)
      - pattern: ET.parse(...)
      - pattern: ET.fromstring(...)
      - pattern: xml.dom.minidom.parse(...)
      - pattern: xml.dom.minidom.parseString(...)
    message: "XXE vulnerability - use defusedxml instead"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-611"

  # ============================================================
  # CWE-502: Insecure Deserialization
  # ============================================================
  - id: insecure-deserialization-pickle
    patterns:
      - pattern: pickle.loads(...)
      - pattern: pickle.load(...)
      - pattern: cPickle.loads(...)
      - pattern: cPickle.load(...)
    message: "Insecure deserialization via pickle"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"

  - id: insecure-deserialization-yaml
    pattern: yaml.load(...) 
    fix: yaml.safe_load(...)
    message: "Use yaml.safe_load() instead of yaml.load()"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"

  - id: insecure-deserialization-marshal
    patterns:
      - pattern: marshal.loads(...)
      - pattern: marshal.load(...)
    message: "Insecure deserialization via marshal"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-502"

  # ============================================================
  # CWE-94: Code Injection
  # ============================================================
  - id: code-injection-eval
    patterns:
      - pattern: eval(...)
      - pattern: exec(...)
      - pattern: compile(..., ..., "exec")
    message: "Code injection via eval/exec"
    languages: [python]
    severity: ERROR
    metadata:
      cwe: "CWE-94"

  - id: code-injection-js-eval
    pattern: eval(...)
    message: "Code injection via eval"
    languages: [javascript, typescript]
    severity: ERROR
    metadata:
      cwe: "CWE-94"
